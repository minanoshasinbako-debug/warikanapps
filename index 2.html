<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‰²ã‚Šå‹˜ç²¾ç®— Pro - å‡ç­‰é…åˆ†ç‰ˆ</title>
    <style>
        :root { --primary: #007AFF; --bg: #F2F2F7; --card: #FFFFFF; --text: #1C1C1E; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 16px; padding-bottom: 120px; -webkit-text-size-adjust: 100%; }
        .status-box { background: #1C1C1E; color: white; padding: 18px; border-radius: 12px; margin-bottom: 16px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .total-val { font-size: 30px; font-weight: bold; color: #34C759; margin-top: 5px; }
        .file-box { background: #FFF; border: 2px dashed var(--primary); padding: 15px; text-align: center; border-radius: 12px; margin-bottom: 20px; color: var(--primary); font-weight: bold; font-size: 15px; cursor: pointer; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h2 { font-size: 14px; margin: 0 0 12px 0; color: #666; font-weight: bold; border-left: 4px solid var(--primary); padding-left: 8px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #D1D1D6; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: white; color: var(--text); }
        .target-select { font-size: 15px; font-weight: bold; color: var(--primary); background-color: #F0F7FF; border: 2px solid var(--primary); margin-top: 8px; height: 48px; }
        .item-row { display: grid; grid-template-columns: 1.8fr 0.6fr 1.2fr 40px; gap: 6px; margin-bottom: 4px; align-items: center; }
        .btn-del { background: #FF3B30; color: white; border: none; border-radius: 6px; height: 42px; font-weight: bold; font-size: 18px; }
        .member-card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 12px; border-left: 8px solid #34C759; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .member-card.remote { border-left-color: #5856D6; background: #F9F9FB; }
        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .pay-display { font-weight: bold; font-size: 24px; color: var(--primary); text-align: right; background: #F2F2F7; border-radius: 8px; padding: 10px; border: 1px solid #D1D1D6; }
        .gift-input { border: 2px solid #34C759 !important; font-weight: bold; background: #F0FFF4; }
        .btn-add { background: #E5E5EA; color: #333; border: none; padding: 15px; border-radius: 10px; width: 100%; font-weight: bold; margin-bottom: 10px; }
        .btn-copy { background: var(--primary); color: white; width: calc(100% - 32px); position: fixed; bottom: 20px; left: 16px; padding: 20px; border-radius: 14px; border: none; font-size: 18px; font-weight: bold; box-shadow: 0 5px 20px rgba(0,122,255,0.4); z-index: 200; }
    </style>
</head>
<body>

    <div class="status-box">
        <div style="font-size: 12px; opacity: 0.9;">é›†ã‚ã‚‹ã¹ãåˆè¨ˆï¼ˆé›†é‡‘ç›®æ¨™ï¼‰</div>
        <div class="total-val"><span id="targetTotalDisplay">0</span> å††</div>
    </div>

    <div class="file-box" onclick="document.getElementById('memberFile').click()">
        ğŸ“ ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’èª­è¾¼ (.txt)
        <input type="file" id="memberFile" accept=".txt" onchange="loadMemberList(event)" style="display:none;">
    </div>

    <div class="card">
        <h2>ğŸ§¾ é …ç›®ã¨è² æ‹…è¨­å®š</h2>
        <div id="receiptList"></div>
        <button class="btn-add" onclick="addReceipt()">ï¼‹ æ–°ã—ã„é …ç›®ã‚’è¿½åŠ </button>
    </div>

    <h2>ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ã¨ã‚«ãƒ³ãƒ‘é¡</h2>
    <div id="memberList"></div>
    <button class="btn-add" style="background:white; border:2px dashed #CCC;" onclick="addMember()">ï¼‹ ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ‰‹å‹•è¿½åŠ </button>

    <button class="btn-copy" onclick="copyToClipboard()">ç²¾ç®—çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¦é€ä¿¡</button>

<script>
    let receipts = [
        { label: 'ä¼šå ´è²»', price: 1200, qty: 1, target: 'all' },
        { label: 'ãŠå¼å½“', price: 1000, qty: 10, target: 'split_only' },
        { label: 'æ¥å®¢ç”¨å¼å½“', price: 1000, qty: 3, target: 'split_only' }
    ];

    let members = [
        { name: 'å¹¹äº‹', type: 'split', gift: 0 },
        { name: 'å‚åŠ è€…1', type: 'split', gift: 0 }
    ];

    window.onload = () => { renderAll(); };

    function renderAll() {
        renderReceipts();
        renderMembers();
        updateCalculations();
    }

    function addReceipt() {
        receipts.push({ label: 'æ–°è¦é …ç›®', price: 0, qty: 1, target: 'all' });
        renderAll();
    }

    function addMember() {
        members.push({ name: 'æ–°ãƒ¡ãƒ³ãƒãƒ¼', type: 'split', gift: 0 });
        renderAll();
    }

    function loadMemberList(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const names = e.target.result.split(/\r?\n/).filter(n => n.trim() !== "");
            if (names.length > 0) {
                members = names.map(n => ({ name: n.trim(), type: 'split', gift: 0 }));
                renderAll();
            }
        };
        reader.readAsText(file);
    }

    function renderReceipts() {
        const list = document.getElementById('receiptList');
        list.innerHTML = receipts.map((r, i) => `
            <div style="margin-bottom:15px; border-bottom:1px solid #EEE; padding-bottom:10px;">
                <div class="item-row">
                    <input type="text" value="${r.label}" oninput="receipts[${i}].label=this.value; updateCalculations();">
                    <input type="number" value="${r.qty}" oninput="receipts[${i}].qty=parseFloat(this.value)||0; updateCalculations();">
                    <input type="number" value="${r.price}" oninput="receipts[${i}].price=parseFloat(this.value)||0; updateCalculations();">
                    <button class="btn-del" onclick="receipts.splice(${i},1); renderAll();">âœ•</button>
                </div>
                <select class="target-select" onchange="receipts[${i}].target=this.value; updateCalculations();">
                    <option value="all" ${r.target==='all'?'selected':''}>ğŸ‘¥ å…¨å“¡ã§å‰²ã‚Šå‹˜ï¼ˆä¸å‚åŠ å«ã‚€ï¼‰</option>
                    <option value="split_only" ${r.target==='split_only'?'selected':''}>ğŸ´ å‚åŠ è€…ã®ã¿ã§å‰²ã‚Šå‹˜</option>
                </select>
            </div>
        `).join('');
    }

    function renderMembers() {
        const list = document.getElementById('memberList');
        list.innerHTML = members.map((m, i) => `
            <div class="member-card ${m.type}" id="m-card-${i}">
                <div class="member-header">
                    <input type="text" value="${m.name}" oninput="members[${i}].name=this.value" style="flex:2; font-weight:bold;">
                    <select onchange="members[${i}].type=this.value; updateCalculations(); document.getElementById('m-card-${i}').className='member-card '+this.value;" style="width:100px;">
                        <option value="split" ${m.type==='split'?'selected':''}>å‚åŠ </option>
                        <option value="remote" ${m.type==='remote'?'selected':''}>ä¸å‚åŠ </option>
                    </select>
                    <button class="btn-del" style="width:40px; height:40px;" onclick="members.splice(${i},1); renderAll();">âœ•</button>
                </div>
                <div class="input-group">
                    <div>
                        <span style="font-size:11px; color:#34C759; font-weight:bold;">ğŸ ã‚«ãƒ³ãƒ‘å…¥åŠ›</span>
                        <input type="number" value="${m.gift}" oninput="members[${i}].gift=parseFloat(this.value)||0; updateCalculations();" class="gift-input">
                    </div>
                    <div>
                        <span style="font-size:11px; color:#666; font-weight:bold;">ğŸ’° å½“æ—¥æ”¯æ‰•é¡</span>
                        <div class="pay-display" id="pay-val-${i}">0</div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function updateCalculations() {
        let poolAll = 0, poolSplit = 0;
        receipts.forEach(r => { 
            const total = r.price * r.qty;
            if(r.target==='all') poolAll += total; else poolSplit += total; 
        });

        const totalCost = poolAll + poolSplit;
        const totalGift = members.reduce((sum, m) => sum + m.gift, 0);
        const targetToCollect = Math.max(0, totalCost - totalGift);
        
        const participants = members.filter(m => m.type === 'split');
        const allMemberCount = members.length || 1;
        const participantCount = participants.length || 1;

        // 1. å„è‡ªã®ã€Œç´”ç²‹ãªåˆ†æ‹…é¡ã€ã‚’å°æ•°ç‚¹è¾¼ã¿ã§è¨ˆç®—
        members.forEach(m => {
            let myShare = (poolAll / allMemberCount);
            if (m.type === 'split') {
                myShare += (poolSplit / participantCount);
            }
            // ã¾ãšã¯åˆ‡ã‚Šæ¨ã¦ã§ä»®ã®é‡‘é¡ã‚’æ±ºã‚ã‚‹
            m.tempPay = Math.max(0, Math.floor(myShare - m.gift));
        });

        // 2. åˆ‡ã‚Šæ¨ã¦ã«ã‚ˆã£ã¦ç”Ÿã˜ãŸã€Œä¸è¶³åˆ†ã€ã‚’è¨ˆç®—
        let currentSum = members.reduce((sum, m) => sum + m.tempPay, 0);
        let diff = targetToCollect - currentSum;
        
        // 3. ä¸è¶³åˆ†ã‚’ã€Œæ”¯æ‰•ã„ãŒã‚ã‚‹äººã€ã«1å††ãšã¤é †ç•ªã«é…ã‚‹ï¼ˆã“ã‚Œã§ä¸€äººã«é›†ä¸­ã—ãªã„ï¼‰
        let realPayers = members.filter(m => m.tempPay > 0);
        if (realPayers.length > 0) {
            let i = 0;
            while (diff > 0) {
                realPayers[i % realPayers.length].tempPay += 1;
                diff--;
                i++;
            }
        } else if (diff > 0 && members.length > 0) {
            // ä¸‡ãŒä¸€ã€å…¨å“¡ã‚«ãƒ³ãƒ‘ã§tempPayãŒ0ã ãŒåˆè¨ˆãŒåˆã‚ãªã„å ´åˆï¼ˆç¨€ï¼‰
            members[0].tempPay += diff;
        }

        document.getElementById('targetTotalDisplay').textContent = targetToCollect.toLocaleString();
        members.forEach((m, i) => {
            const el = document.getElementById(`pay-val-${i}`);
            if (el) el.textContent = m.tempPay.toLocaleString();
        });
    }

    function copyToClipboard() {
        let text = "ã€ç²¾ç®—è©³ç´°ã€‘\n\n--- ğŸ§¾ çµŒè²»å†…è¨³ ---\n";
        let grandTotal = 0;
        receipts.forEach(r => { 
            const itemTotal = r.qty * r.price;
            grandTotal += itemTotal;
            text += `${r.label}: ${r.qty}Ã—${r.price.toLocaleString()}å†† ï¼ ${itemTotal.toLocaleString()}å††\n`; 
        });
        text += `[ çµŒè²»ç·è¨ˆ: ${grandTotal.toLocaleString()}å†† ]\n`;

        const givers = members.filter(m => m.gift > 0);
        if (givers.length > 0) {
            const giftTotal = givers.reduce((sum, m) => sum + m.gift, 0);
            text += "\n--- ğŸ æ—¢æ‰•ãƒ»ã‚«ãƒ³ãƒ‘æ˜ç´° ---\n";
            givers.forEach(m => { text += `${m.name}: ${m.gift.toLocaleString()}å††\n`; });
            text += `[ ã‚«ãƒ³ãƒ‘ç·è¨ˆ: ${giftTotal.toLocaleString()}å†† ]\n`;
        }

        const collectTarget = Math.max(0, grandTotal - givers.reduce((sum, m) => sum + m.gift, 0));
        text += `\n--- ğŸ’° å½“æ—¥ã®ãŠæ”¯æ‰•ï¼ˆé›†é‡‘ç›®æ¨™: ${collectTarget.toLocaleString()}å††ï¼‰ ---\n`;
        members.forEach(m => { 
            if(m.tempPay > 0 || m.type === 'split') {
                text += `${m.name}: ${m.tempPay.toLocaleString()}å††\n`; 
            }
        });
        text += "\nã”ç¢ºèªã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼";
        navigator.clipboard.writeText(text).then(() => alert("å‡ç­‰ç²¾ç®—çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"));
    }
</script>
</body>
</html>
